---
title: "Untitled"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    # vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(plyr)
library(shiny)
library(tidyverse)
library(plotly)

# Read the sealevel dataset 
sealevel <- read_csv("../data/deltares/results/dutch-sea-level-monitor-export-2020-11-25.csv",
                     comment = "#")
# read observed component dataset
observed_components_no_tide <- read_csv("../data/deltares/observed_components_no_tide.csv")
# read projected data


url <- "../data/knmi/cmip5/SeaLevelPerc_KNMI14.csv"
knmi_df <- read_csv(url, comment = "#")
# everything in mm
knmi_df$perc_ts <- knmi_df$perc_ts * 10

# TODO: use consistent epoch (see http://localhost:8889/notebooks/analysis/scenarios/scenario-vs-measurements.ipynb)
# Now they start in 2006 which is not compatible with the old method.

# TODO: add/subtract subsidence
# Double check if new scenarios are including subsidence

rename <- dplyr::rename
# merge  percentiles
knmi_perc10_df <- knmi_df %>% filter(percentiles==10) %>% select(time, scenario, proc, perc_ts) %>%  rename(perc_ts_10=perc_ts)
knmi_perc50_df <- knmi_df %>% filter(percentiles==50) %>% select(time, scenario, proc, perc_ts) %>%  rename(perc_ts_50=perc_ts)
knmi_perc90_df <- knmi_df %>% filter(percentiles==90) %>% select(time, scenario, proc, perc_ts) %>%  rename(perc_ts_90=perc_ts)

observation_mapping <- list(
  `Surge [mm]` = "surge", 
  `Steric [mean]` = "steric",	
  `Glaciers [mean]` = "glaciers", 
  `Greenland Ice Sheet [mean]` = "greenland", 
  `Antarctic Ice Sheet [mean]` = "antarctica", 
  `Terrestrial Water Storage [mean]` = "terrestrial",	
  `GIA [mean]` = "gia", 
  'sea_surface_height_due_to_tide [mm]' = "tide"
)

projection_mapping <- list(
  `Local ocean` = "steric",
  `Inverse barometer` = "surge",
  `Glaciers` = "glaciers",
  `Landwater` = "terrestrial",
  `sum anta.` = "antarctica",
  `Greenland SMB` = "greenland",
  `Greenland dynamics` = "greenland"
)

# mapping <- list(observations= observation_mapping, knmi=knmi_mapping)

processes <- unname(unlist(observation_mapping))
scenarios <- unique(knmi_df$scenario)

# map data to processes
# 
names(observed_components_no_tide) <- recode(names(observed_components_no_tide), !!!observation_mapping)
sealevelPlus <- sealevel %>% left_join(observed_components_no_tide, by = c(year = "Year"))

knmi_perc_df <- merge(merge(knmi_perc10_df, knmi_perc50_df), knmi_perc90_df) %>% filter(proc=="Total")

knmi_mapped <- knmi_perc50_df %>% 
  mutate(proc = recode(proc, !!!projection_mapping)) %>%
  filter(proc %in% unname(unlist(projection_mapping))) %>%
  rename(component = proc,
         value = perc_ts_50,
         year = time) %>%
  group_by(year, component, scenario) %>%
  summarize(value = sum(value))

#== visualisation settings =======================

theme_set(theme_minimal())

plotFillColors = c("surge" = "lightblue",
               "steric" = "blue", 
               "glaciers" = "lightgrey", 
               "greenland" = "green", 
               "terrestrial" = "brown", 
               "gia" = "red",
               "antarctica" = "orange"
               )


```



Sidebar {.sidebar}
=======================================================================

```{r}
selectInput("exclude",
            "Excluded processes:",
            choices = processes,
            multiple=TRUE)

```

### Scenarios

```{r}
selectInput("scenario",
            "Scenario:",
            choices = scenarios)

```

### Fit

```{r}
selectInput("fitType",
            "Fit type:",
            choices = c("linear", "broken linear", "quadratic", "loess")
            )

```



```{r}

shiny::conditionalPanel(
  condition = "input.fitType == 'loess'",
  h4("Fit parameter"),
  sliderInput("span",
              "Span:",
              min = 0.01,
              max = 1,
              value = 0.5)
  
)
```

```{r}
shiny::conditionalPanel(
  condition = "input.fitType == 'broken linear'",
  h4("Fit parameter"),
  sliderInput("breakpoint",
              "Break:",
              min = 1950,
              max = 1995,
              value = 1970,
              sep = "")
)
```


Dashboard
=======================================================================

Column {data-width=500} {.tabset}
-----------------------------------------------------------------------

### Sea surface height 

```{r}

renderPlotly({
  # Lookup components to subtract
  # Map components with mapping to correct variable name
  # Subtract variable from height / perc_ts_50 
  # do not show the CI bands: perc_ts_10, perc_ts_90
  
  fig <- ggplot(sealevel, aes(year, height))
  
  # Show measurements
  fig <- fig + geom_point()
  
  # if selected show loess
  if (input$`fitType` == 'loess') {
    # generate span based on input
    span <- input$span
    
    # draw the histogram with the specified number of bins
    fig <- fig  + geom_smooth(span = span)
  }
  
  # if selected show broken linear model
  if (input$`fitType` == 'broken linear') {
    # generate breakpoint from ui.R
    breakpoint <- input$breakpoint
    covariate <-
      (sealevel$year > breakpoint) * (sealevel$year - breakpoint)
    
    # draw the broken  trend line
    broken <-
      geom_smooth(
        method = "glm",
        n = nrow(sealevel),
        formula = y ~ x + covariate +  1
      )
    fig <- fig + broken
  }
  
  # if selected show linear model
  if (input$`fitType` == "linear") {
    linear <-
      geom_smooth(
        method = "glm",
        n = nrow(sealevel),
        formula = y ~ x + 1,
        aes(),
        colour = 'red'
      )
    fig <- fig + linear
  }
  
    # if selected show linear model
  if (input$`fitType` == "quadratic") {
    quadratic <-
      geom_smooth(
        method = "glm",
        n = nrow(sealevel),
        formula = y ~ x + I(x^2) + 1, # is linear term necessary?
        aes(),
        colour = 'green'
      )
    fig <- fig + quadratic
  }

  
  fig <- fig + geom_line(data = knmi_perc_df, mapping = aes(time, perc_ts_50, colour = scenario)) + 
    geom_ribbon(data = knmi_perc_df, aes(
                             x = time,
                             y=perc_ts_50,
                             ymin = perc_ts_10,
                             ymax = perc_ts_90,
                             colour = scenario,
                             fill = scenario
                           ),
                           alpha = 0.1
                         )
  
  # fig <- (
  #   fig +
  #     geom_line(
  #       data = knmi_perc_df,
  #       mapping = aes(time, perc_ts_50, colour = scenario)
  #     )  +
  #     geom_ribbon(
  #       data = knmi_perc_df,
  #       mapping = aes(
  #         x = time,
  #         ymin = perc_ts_10,
  #         ymax = perc_ts_90,
  #         colour = scenario,
  #         fill = scenario
  #       ),
  #       alpha = 0.1
  #     )
  # )
  # 
  
  # print(fig)
  ggplotly(fig)
  
}#, height = 500
)


```


### Underlying processes


text....





```{r bijdrageComponentenMetingen}

# werkt nu niet, weet niet waarom
myStyle = 
  ylab("sea level change (mm)") +
  scale_fill_manual(values = plotFillColors) +
  coord_cartesian(ylim = c(-75, 320)) +
  theme(legend.position = "bottom")



fillPage(
  fillRow(height = 600, flex = c(0.5, 0.5), 
          # inputPanel(
          #   selectInput("scenario", "Scenario:", choices = scenarios)
          # ),
          plotlyOutput("observationPlot", height = "100%", width = "50%"),
          plotlyOutput("projectionPlot", height = "100%", width = "50%")
  )
)


output$observationPlot <- renderPlotly({
fig <- sealevelPlus %>% 
  select(
    year, steric, glaciers, greenland, antarctica, terrestrial # gia and surge removed. not in scenarios
    # `Surge [mm]`, `Steric [mean]`, `Glaciers [mean]`, `Greenland Ice Sheet [mean]`,
    # `Antarctic Ice Sheet [mean]`, `Terrestrial Water Storage [mean]`, `GIA [mean]`
  ) %>%
  pivot_longer(cols = c(steric, glaciers, greenland, antarctica, terrestrial),
               names_to = "component", values_to = "value"
               ) %>% 
  mutate(
    positive = case_when(
      value >= 0 ~ value,
      value < 0 ~ 0
    ),
    negative = case_when(
      value < 0 ~ value,
      value >= 0 ~ 0
    )
  ) %>%
  ggplot(aes(x = year)) +
  geom_area(aes(y = positive, fill = component), position = 'stack') +
  geom_area(aes(y = negative, fill = component), position = 'stack') +
    ylab("sea level change (mm)") +
  scale_fill_manual(values = plotFillColors) +
  coord_cartesian(ylim = c(-75, 320)) +
  theme(legend.position = "none")


# plot(fig)
ggplotly(fig)
  
})

output$projectionPlot <- renderPlotly({
  fig <- knmi_mapped %>%
      filter(scenario ==input$scenario) %>%
    mutate(
      positive = case_when(
        value >= 0 ~ value,
        value < 0 ~ 0
      ),
      negative = case_when(
        value < 0 ~ value,
        value >= 0 ~ 0
      )
    ) %>%
    ggplot(aes(x = year)) +
    geom_area(aes(y = positive, fill = component), position = 'stack') +
    geom_area(aes(y = negative, fill = component), position = 'stack') +
      ylab("sea level change (mm)") +
  scale_fill_manual(values = plotFillColors) +
  coord_cartesian(ylim = c(-75, 320)) +
  theme(legend.position = "bottom")

  
  # plot(fig)
  ggplotly(fig)
})
```


