---
title: "Observed and projected sea level change along the Dutch coast"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    # vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}

library(flexdashboard)
library(shiny)
library(shinyWidgets)
library(tidyverse)
library(plotly)
library(shinyBS)
rename <- dplyr::rename
shiny::enableBookmarking(store='server')

# Read the sealevel dataset 
sealevel <- read_csv("../data/deltares/results/dutch-sea-level-monitor-export-2020-11-25.csv",
                     comment = "#")
# read observed component dataset
observed_components_no_tide <- read_csv("../data/deltares/observed_components_no_tide.csv")

# read projected data
url <- "../data/knmi/cmip5/SeaLevelPerc_KNMI14.csv"
knmi_df <- read_csv(url, comment = "#") %>%
  mutate(perc_ts = 10*perc_ts)                        # everything in mm

#### DONE? FEDOR could you check these points once more?  
# TODO: use consistent epoch (see http://localhost:8889/notebooks/analysis/scenarios/scenario-vs-measurements.ipynb)
# Now they start in 2006 which is not compatible with the old method.

# TODO: add/subtract subsidence
# Double check if new scenarios are including subsidence

# merge  percentiles
knmi_perc10_df <- knmi_df %>% filter(percentiles==10) %>% select(time, scenario, proc, perc_ts) %>%  rename(perc_ts_10=perc_ts)
knmi_perc50_df <- knmi_df %>% filter(percentiles==50) %>% select(time, scenario, proc, perc_ts) %>%  rename(perc_ts_50=perc_ts)
knmi_perc90_df <- knmi_df %>% filter(percentiles==90) %>% select(time, scenario, proc, perc_ts) %>%  rename(perc_ts_90=perc_ts)

#=== name mappings =============

observation_mapping <- list(
  `Surge [mm]` = "other", 
  `Steric [mean]` = "steric",
  `Glaciers [mean]` = "glaciers", 
  `Greenland Ice Sheet [mean]` = "greenland", 
  `Antarctic Ice Sheet [mean]` = "antarctica", 
  `Terrestrial Water Storage [mean]` = "terrestrial",	
  `GIA [mean]` = "other"#, 
  # `sea_surface_height_due_to_tide [mm]` = "tide"
)

projection_mapping <- list(
  `Global steric` = "other",  # Dewi discuss with Fedor
  `Local ocean` = "steric",  # Dewi: this is local steric and wind combined
  `Inverse barometer` = "other",
  `Glaciers` = "glaciers",
  `Greenland SMB` = "greenland",
  `Greenland dynamics` = "greenland",
  `Landwater` = "terrestrial",
  `sum anta.` = "antarctica"
  )

# map data to processes

sealevelPlus <- observed_components_no_tide %>%
  pivot_longer(cols = -Year, names_to = "proc") %>%
  mutate(proc = recode(proc, !!!observation_mapping)) %>%  # apply mapping
  filter(proc %in% unname(unlist(observation_mapping))) %>%  # remove all unmapped processes
  rename(component = proc,
         value = value,
         year = Year) %>%
  group_by(year, component) %>%
  summarize(value = sum(value), .groups = "drop") %>% 
  pivot_wider(id_cols = c(year), names_from = "component") %>%
  right_join(sealevel %>% select(year, height)) %>%
  arrange(year)

knmi_perc_df <- merge(merge(knmi_perc10_df, knmi_perc50_df), knmi_perc90_df) %>% filter(proc=="Total")

knmi_mapped <- knmi_perc50_df %>% 
  mutate(proc = recode(proc, !!!projection_mapping)) %>%
  filter(proc %in% unname(unlist(projection_mapping))) %>%
  rename(component = proc,
         value = perc_ts_50,
         year = time) %>%
  group_by(year, component, scenario) %>%
  summarize(value = sum(value), .groups = "drop")

processes <- unique(knmi_mapped$component)
scenarios <- unique(knmi_mapped$scenario)

#====== visualisation settings =======================

theme_set(theme_light())

# names on left side appear in legend for processes plot
# 
plotFillColors = c(
  # "surge" = "lightblue",
  "steric" = "blue", 
  "glaciers" = "lightgrey", 
  "greenland" = "green", 
  "terrestrial" = "brown", 
  "gia" = "red",
  "antarctica" = "orange",
  "other" = "yellow"
)

# names on left side appear as legend in scenario plot
plotColorColors = c(
"yearly average sea level" = "darkgrey",
# "excluded processes" = "darkolivegreen2",
"fitted sea level" = "coral2",
"projected sea level" = "blue",
"projected sea level range" = "red",
"sea level excl selected processes" = "darkolivegreen2",
"obs excl processes" = "black"
)

showSE = 0 # alpha for all smoothings




```


Dutch sea level
=======================================================================


Sidebar {.sidebar}
------------------------------------------------------------


### Preferences

```{r}

# voor dikkere horizontale lijnen (werkt niet op dit moment)
  # tags$head(
  #   tags$style(HTML("hr {border-top: 3px solid #000000;}"))
  # )


radioGroupButtons(
   inputId = "scenario",
   label = "Choose the projection scenario:", 
    choices = scenarios,
   status = "primary"
)

bsPopover(id = "scenario", 
          title = "Climate scenario used to calculate sealevel", 
          content = paste("rcp45 = .........;", 
                          "rcp85 = .......", 
                          sep = "<br>"), 
          placement = "bottom", trigger = "hover",
          options = list(container = "body"))

hr() # horizontal line

radioGroupButtons(
  inputId = "mode",
  label = "switch to expert mode:", 
  choices = c("normal", "expert"),
  status = "normal"
)

bsPopover(id = "mode", 
          title = "Expert mode to:", 
          content = paste("*  see effect of individual processes",
                          "*  show different model fits through observations",
                          sep = "<br>"),
          placement = "bottom", 
          trigger = "hover")


conditionalPanel(
  condition = "input.mode == 'expert'",
  
  inputPanel(width = "25%",
             tags$h3("Underlying processes"),
             checkboxGroupButtons(
               inputId = "exclude",
               label = "Choose the underlying processes for sea level variation that you want to exclude from the chart:",
               choices = processes,
               direction = "vertical"
             ),
             hr(),
             tags$h3("Fit model to observations"),
             selectInput("fitType",
                         "Fit type:",
                         choices = c("linear", "broken linear", "quadratic", "loess")
             ),
             shiny::conditionalPanel(
               condition = "input.fitType == 'loess'",
               # hr(),
               h4("Fit parameter"),
               sliderInput("span",
                           "Span of loess function:",
                           min = 0.01,
                           max = 1,
                           value = 0.5)
             ),
             shiny::conditionalPanel(
               condition = "input.fitType == 'broken linear'",
               # hr(),
               h4("Fit parameter"),
               sliderInput("breakpoint",
                           "year of break:",
                           min = 1950,
                           max = 1995,
                           value = 1970,
                           sep = "")
             )
  )
)



bookmarkButton()

```


```{r}

# conditionalPanel(
#   condition="input.tabselected==sealevel",
#   h4("Demo conditionalPanel")
# )

```


Column 
-----------------------------------------------------------------------

### 

```{r}

fillPage(
  fillRow(height = 500, flex = c(1,1), 
          # inputPanel(
          #   selectInput("scenario", "Scenario:", choices = scenarios)
          # ),
          plotlyOutput("combinedPlot", height = "100%", width = "50%")#,
  )
)

output$combinedPlot <- renderPlotly({

  sealevelPlus2 <- sealevelPlus %>% 
    # select(
    #   year, height, steric, glaciers, greenland, antarctica, terrestrial # gia and surge removed. not in scenarios
    # ) %>% 
    # replace(is.na(.), 0) %>%
    mutate(subtract = rowSums(across(input$exclude))) %>%  # example: c("glaciers", "greenland")
    mutate(value = height - subtract)
  
  knmi_mapped2 <- knmi_mapped %>%
    filter(scenario == input$scenario) %>% # "rcp45"
    pivot_wider(id_cols = c(year, scenario), names_from = component, values_from = value) %>%
    left_join(knmi_perc_df %>% select(year = time, scenario, `median height` = perc_ts_50, `10th percentile` = perc_ts_10, `90th percentile` = perc_ts_90)) %>%
    # replace(is.na(.), 0) %>%
    mutate(subtract = rowSums(across(input$exclude))) %>%  # example: c("glaciers", "greenland")
    mutate(value = `median height` - subtract)
  
  
  fig <- ggplot(sealevelPlus2, aes(year, height))
  
  # Show measurements
  fig <- fig + 
    geom_hline(yintercept = 0, color = "bisque4") +
    annotate("text", label = "NAP", x = 1900, y = 25, size = 6, color = "bisque4") +
    geom_point(mapping = aes(color = "yearly average sea level"))
  
  # if selected show loess
  if (input$`fitType` == 'loess') {
    # generate span based on input
    span <- input$span
    
    # draw the histogram with the specified number of bins
    fig <- fig  + geom_smooth(method = "loess", 
                              span = span, 
                              alpha = showSE, 
                              mapping = aes(color = "fitted sea level")
                              )
  }
  
  # if selected show broken linear model
  if (input$`fitType` == 'broken linear') {
    # generate breakpoint from ui.R
    breakpoint <- input$breakpoint
    covariate <-
      (sealevelPlus2$year > breakpoint) * (sealevelPlus2$year - breakpoint)
    
    # draw the broken  trend line
    broken <-
      geom_smooth(
        method = "glm", alpha = showSE ,
        n = nrow(sealevelPlus2),
        formula = y ~ x + covariate +  1, 
        mapping = aes(color = "fitted sea level")
      ) 
    
    fig <- fig + broken + 
      geom_vline(xintercept = input$breakpoint, color = "grey")
  }
  
  # if selected show linear model
  if (input$`fitType` == "linear") {
    linear <-
      geom_smooth(
        method = "glm", alpha = showSE,
        n = nrow(sealevelPlus2),
        formula = y ~ x + 1,
        mapping = aes(color = "fitted sea level")
      )
    fig <- fig + linear
  }
  
  # if selected show quadratic model
  if (input$`fitType` == "quadratic") {
    quadratic <-
      geom_smooth(
        method = "glm", alpha = showSE,
        n = nrow(sealevelPlus2),
        formula = y ~ x + I(x^2) + 1, # is linear term necessary?
        mapping = aes(color = "fitted sea level")
      )
    fig <- fig + quadratic
  }
  
  
  fig <- fig + 
    geom_line(data = knmi_mapped2, 
              mapping = aes(year, `median height`, color = "projected sea level")
    )
  
  fig = fig +
    geom_ribbon(data = knmi_mapped2, aes(
      x = year,
      y=`median height`,
      ymin = `10th percentile`,
      ymax = `90th percentile`,
      color = "projected sea level range"
    ),
    alpha = 0.1,
    show.legend = T # change to F to remove this item from legend
    ) 
  
  if(length(input$exclude) != 0){
    fig = fig +
      geom_point(data = sealevelPlus2, aes(year, value, color = "sea level excl selected processes"), size = 2, alpha = 0.8) +
      # geom_smooth(data = sealevelPlus2, aes(year, value, color = "fitted sea level"), size = 1.5, method = "lm", alpha = showSE) +
      geom_line(data = knmi_mapped2, aes(year, value, color = "sea level excl selected processes"), size = 1.5, alpha = 0.8)
  }
  
  fig = fig + 
    coord_cartesian(ylim = c(-250, 750)) +
    ggtitle("Observed and projected sea level at the Dutch coast, in mm") +
    scale_color_manual(values = plotColorColors) +
    ylab("sealevel in mm relative to NAP") +
    theme(legend.position = "top")
  
  # print(fig)
  ggplotly(fig) %>% layout(legend = list(orientation = 'h'))
  
  # further styling of plotly legend: https://plotly.com/r/legend/ 
  
}     #, height = 500  # in case the plot is printed as png
)


```




Underlying processes
======================================================================

Sidebar {.sidebar}
------------------------------------------------------------

### Preferences

```{r}
radioGroupButtons(
   inputId = "scenario2",
   label = "Choose the projection scenario:", 
    choices = scenarios,
   status = "primary"
)

bsPopover(id = "scenario2", 
          title = "Climate scenario used to calculate sealevel", 
          content = paste("rcp45 = .........;", 
                          "rcp85 = .......", 
                          sep = "<br>"), 
          placement = "bottom", trigger = "hover",
          options = list(container = "body"))

```

Column 
-----------------------------------------------------------------------

###

```{r bijdrageComponentenMetingen}

# werkt nu niet, weet niet waarom
myStyle = 
  ylab("sea level change (mm)") +
  scale_fill_manual(values = plotFillColors) +
  coord_cartesian(ylim = c(-75, 320)) +
  theme(legend.position = "bottom")



fillPage(
  fillRow(height = 500, flex = c(1,1), 
          # inputPanel(
          #   selectInput("scenario", "Scenario:", choices = scenarios)
          # ),
          plotlyOutput("processPlot", height = "100%", width = "50%")#,
  )
)


output$processPlot <- renderPlotly({
  fig <- sealevelPlus %>% 
    # select(
    #   year, steric, glaciers, greenland, antarctica, terrestrial # gia and surge removed. not in scenarios
    #   # `Surge [mm]`, `Steric [mean]`, `Glaciers [mean]`, `Greenland Ice Sheet [mean]`,
    #   # `Antarctic Ice Sheet [mean]`, `Terrestrial Water Storage [mean]`, `GIA [mean]`
    # ) %>%
    pivot_longer(cols = -c(year, height),
                 names_to = "component", values_to = "value"
    ) %>% 
    mutate(
      positive = case_when(
        value >= 0 ~ value,
        value < 0 ~ 0
      ),
      negative = case_when(
        value < 0 ~ value,
        value >= 0 ~ 0
      )
    ) %>%
    ggplot(aes(x = year)) +
    geom_area(aes(y = positive, fill = component), position = 'stack') +
    geom_area(aes(y = negative, fill = component), position = 'stack') +
    
    geom_area(data = knmi_mapped %>%
                filter(scenario ==input$scenario2) %>%
                mutate(
                  positive = case_when(
                    value >= 0 ~ value,
                    value < 0 ~ 0
                  ),
                  negative = case_when(
                    value < 0 ~ value,
                    value >= 0 ~ 0
                  )
                ), 
              aes(y = positive, fill = component), position = 'stack', alpha = 0.5) +
    geom_area(data = knmi_mapped %>%
                filter(scenario ==input$scenario2) %>%
                mutate(
                  positive = case_when(
                    value >= 0 ~ value,
                    value < 0 ~ 0
                  ),
                  negative = case_when(
                    value < 0 ~ value,
                    value >= 0 ~ 0
                  )
                ), 
              aes(y = negative, fill = component), position = 'stack', alpha = 0.5) +
    ylab("sea level change (mm)") +
    ggtitle("Underlying processes for sea level variation") +
    scale_fill_manual(values = plotFillColors) +
    coord_cartesian(ylim = c(-75, 320)) +
    theme(legend.position = "bottom")
  
  
  # plot(fig)
  ggplotly(fig)
})
```



Explanation and methods
==========================================================

Column {data-width=300}
-----------------------------------------------------------------------

#### Methods

Calculation of local budgets for observed sealevel is done according to [Python using Jupyter notebook](https://github.com/openearth/sealevel/blob/master/notebooks/analysis/budget/local-budget.ipynb).

Processes contributing to sea level change have been attributed differently to observations and projections. In this visualizations, a mapping was made to link those processes that can be compared between observations and projections. The remaining effects are catechorized under "other" 

The mapping consists of the following for the different data types:

Observations:
```{r}
observation_mapping %>% unlist(use.names = T) %>% as.data.frame() %>% rename(`common name` = "." ) %>% knitr::kable()
```

</br>
Projections
```{r}
projection_mapping %>% unlist(use.names = T) %>% as.data.frame() %>% rename(`common name` = "." ) %>% knitr::kable()
```






